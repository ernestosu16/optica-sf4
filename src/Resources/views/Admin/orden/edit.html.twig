{% extends "SonataAdminBundle:CRUD:edit.html.twig" %}
{% block stylesheets %}
    {{ parent() }}
    <style>
        .select2-container {
            width: 100% !important;
        }
    </style>
{% endblock stylesheets %}
{% block javascripts %}
    {{ parent() }}
    <script type="text/javascript">
        $(document).ready(function () {
            $('select').select2();

            $('#sonata-ba-field-container-{{ admin.uniqid }}_numero').addClass('col-md-6');
            $('#sonata-ba-field-container-{{ admin.uniqid }}_precio').addClass('col-md-6');
            $('#sonata-ba-field-container-{{ admin.uniqid }}_paciente').addClass('col-md-12');
            {#$('#field_widget_{{ admin.uniqid }}_paciente').addClass('col-md-12')#}
            {#    .after("<br><br>");#}

            $('#sonata-ba-field-container-{{ admin.uniqid }}_receta_numero').addClass('col-md-3');
            $('#sonata-ba-field-container-{{ admin.uniqid }}_receta_fecha').addClass('col-md-3');
            $('#sonata-ba-field-container-{{ admin.uniqid }}_receta_dp').addClass('col-md-3');
            $('#sonata-ba-field-container-{{ admin.uniqid }}_receta_add')
                .addClass('col-md-3').after("<div class='row'></div>");


            $('#sonata-ba-field-container-{{ admin.uniqid }}_receta_eje_od').addClass('col-md-3');
            $('#sonata-ba-field-container-{{ admin.uniqid }}_receta_a_visual_od').addClass('col-md-3');
            $('#sonata-ba-field-container-{{ admin.uniqid }}_receta_cristal_od').addClass('col-md-6');

            $('#sonata-ba-field-container-{{ admin.uniqid }}_receta_eje_oi').addClass('col-md-3');
            $('#sonata-ba-field-container-{{ admin.uniqid }}_receta_a_visual_oi').addClass('col-md-3');
            $('#sonata-ba-field-container-{{ admin.uniqid }}_receta_cristal_oi').addClass('col-md-6');

            var oferta = {
                'input_pecio': $("#{{ admin.uniqid }}_precio"),
                'precio_inicial': 2.00,
                'select_precio': [
                    'receta_cristal_od',
                    'receta_cristal_oi',
                    'armadura'
                ],
                /**
                 * @return {void}
                 */
                evento: function () {
                    oferta.select_precio.forEach(function (item, index, array) {
                        $("#{{ admin.uniqid }}_" + item).on('change', function () {
                            oferta.calcularOden();
                        });
                    });
                },

                calcularOden: function () {
                    var importe_total = 0;

                    oferta.select_precio.forEach(function (item, index, array) {
                        importe_total += oferta.getSelectPrecio(
                            $('#{{ admin.uniqid }}_' + item + ' option:selected').text()
                        )
                    });

                    importe_total += oferta.precio_inicial;

                    oferta.setInputPrecio(importe_total);

                },

                /**
                 * Ejemplo:
                 *   text = (+6.9,+11.5) - $1.20, devuelve = 1.2
                 *
                 * @return {number}
                 */
                getSelectPrecio: function (text) {
                    if (!text) {
                        return 0
                    }
                    let precio_string = text.match(/[$]\d+\.\d+/).pop();
                    if (!precio_string) {
                        alert('No se pudo encontrar el precio.');
                        return 0
                    }


                    return parseFloat(precio_string.match(/\d+\.\d+/).pop());
                },

                /**
                 * @return {void}
                 */
                setInputPrecio: function (v) {
                    oferta.input_pecio.val(
                        oferta.NumberFormat(v, 2)
                    )
                },

                /**
                 * @return {string}
                 */
                NumberFormat: function (x, f) {
                    return oferta.CambiarPuntoPorComa(
                        Number.parseFloat(x).toFixed(f)
                    );
                },

                /**
                 * @return {string}
                 */
                CambiarPuntoPorComa: function (text) {
                    return text.toString().replace(/\./g, ',');
                },

                formValidate: function () {
                    // $('form').submit(function (event) {
                    //
                    //     event.preventDefault();
                    // });
                },

                init: function () {
                    this.setInputPrecio(this.precio_inicial);
                    this.evento();
                    this.calcularOden();
                    this.formValidate();
                }
            };

            oferta.init();
        });
    </script>
{% endblock %}